<?include "../../autorisation.php";if(isset($_GET["ChangeVal"])) {  if($_GET["ChangeVal"]=='action') {    $db->query("UPDATE tasks SET action='".intval($_POST["data"])."' WHERE id='".$_POST["id"]."' and toadm='".$ADMIN_ID."'");  }  exit;}$im=array(0=>array("p0.gif","Планируемая"),1=>array("p1.gif","Низкий"),2=>array("p2.gif","Обычный"),3=>array("p3.gif","Повышенный"),4=>array("p4.gif","Высокий"),5=>array("p5.gif","Писец киске"));header("Content-type:text/xml");header("Expires: Thu, Jan 1 1970 00:00:00 GMT");header("Pragma: no-cache");header("Cache-Control: no-cache");echo '<?xml version="1.0" encoding="UTF-8"?'.'>';$db->query("SELECT tasks.*, settings.AdminName FROM tasks,settings WHERE (tasks.toadm='".$ADMIN_ID."' or tasks.sender='".$ADMIN_ID."') and tasks.action!='4' and tasks.sender=settings.id ORDER BY ".(isset($_POST["sort"])? addslashes($_POST["sort"]).",":"")."tasks.date2 DESC");$recs=array();$t=mktime();$d=array(date("Ymd")=>5,date("Ymd",$t+24*3600)=>4,date("Ymd",$t+2*24*3600)=>3,date("Ymd",$t+3*24*3600)=>2,date("Ymd",$t+4*24*3600)=>1);$n=0;$ids=array();$prjids=array();$fids=array();while($db->next_record()) {  if(!$db->Record["status"] && isset($d[$db->Record["date2"]])) {    $db->Record["status"]=$d[$db->Record["date2"]];  }  if(!isset($recs[$db->Record["status"]])) {    $recs[$db->Record["status"]]=array();  }  $recs[$db->Record["status"]][]=$db->Record;  if($db->Record["action"]==1) $ids[]=$db->Record["id"];  if($db->Record["project"]) $prjids[]=$db->Record["project"];  $n++;  $fids[]=$db->Record["id"];}// Читаем проектыif(count($prjids)) {  $db->query("SELECT id,name FROM projects WHERE id in (".join(",",$prjids).")");  $prjids=array();  while($db->next_record()) {    $prjids[$db->Record[0]]=$db->Record[1];  }} else $prjids=array();// Читаем файлыif(count($fids)) {  $db->query("SELECT cod,filename,descript,ftype,fdate FROM taskfiles WHERE cod in (".join(",",$fids).") ORDER BY id");  $files=array();  while($db->next_record()) {    $files[$db->Record["cod"]][]=$db->Record;  }}?><Items>  <Request>    <IsValid>True</IsValid>  </Request>  <TotalResults><?=$n?></TotalResults><?krsort($recs);foreach($recs as $key=>$val) { foreach($val as $v) {  echo "<Item><id>".$v["id"]."</id><ItemAttributes>";  echo "<type><![CDATA[<img src='/".$_CONFIG["ADMINDIR"]."/xprogramms/tasks/";  if($v["sender"]==$v["toadm"]) echo "t_inout.gif' alt='Авто задача'";  elseif($v["sender"]==$ADMIN_ID) echo "t_out.gif' alt='Исходящая задача'";  else echo "t_in.gif' alt='Входящая задача'";  echo " />]]></type>";  echo "<fulltask><![CDATA[<div style='margin:2px 0 10px 5px'>".       "<p><b>Задача:</b><br>".$v["task"]."</p>";       if(isset($files[$v["id"]])) {         echo "<br><p><b>Файлы</b><ol>";         foreach($files[$v["id"]] as $fl) {           echo "<li>[".date("d.m.y H:i",$fl["fdate"])."] <a href='".str_replace("../","/",$fl["filename"])."' target='_blank' ".($fl["ftype"]==1? "":"style='font-weight:bold'").">".($fl["descript"]? $fl["descript"]:substr($fl["filename"],strrpos($fl["filename"],"/")+1))."</a></li>";         }         echo "</ol>";       }  echo "</div>]]></fulltask>";  foreach($v as $k=>$x) if(is_string($k)) {    if($k=='task') {      $x=substr(trim(strip_tags($x)),0,60);    } elseif($k=="status") {      if(isset($im[$x])) $x="<img src='/".$_CONFIG["ADMINDIR"]."/xprogramms/tasks/".$im[$x][0]."' alt='".$im[$x][1]."' />";    } elseif($k=="date1" || $k=="date2") {      $x=substr($x,6,2).".".substr($x,4,2).".".substr($x,0,4);    } elseif($k=="project" && isset($prjids[$x])) {      $x=$prjids[$x];    } else $x=stripslashes($x);    echo "<$k><![CDATA[".$x."]]></$k>";  }  echo "</ItemAttributes></Item>"; }}?></Items><?if(count($ids)) $db->query("UPDATE tasks SET action='2' WHERE id in (".join(",",$ids).")");